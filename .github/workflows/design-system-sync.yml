name: 🎨 Design System Auto-Sync

on:
  # Trigger on design system changes
  push:
    branches: [main, develop, feature/*]
    paths:
      - 'apps/**/src/design/**'
      - 'apps/**/src/components/**'
      - 'packages/design-system/**'
      - 'packages/figma-mcp/**'
      - '**/KlikdBrandSystem.*'
      - '**/design-system.*'
  
  # Trigger on pull requests
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/**/src/design/**'
      - 'apps/**/src/components/**'
      - 'packages/design-system/**'
      - 'packages/figma-mcp/**'
  
  # Manual trigger with custom inputs
  workflow_dispatch:
    inputs:
      figma_file_key:
        description: 'Figma file key to sync with'
        required: true
        default: '2M5cftWvofNAYTV5yuFVkY'
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: false
        type: boolean
      generate_all_formats:
        description: 'Generate all output formats'
        required: false
        default: true
        type: boolean

  # Schedule daily sync (optional)
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC

jobs:
  sync-design-system:
    runs-on: ubuntu-latest
    name: 🔄 Sync Design System with Figma
    
    # Add environment variables
    env:
      FIGMA_FILE_KEY: ${{ github.event.inputs.figma_file_key || '2M5cftWvofNAYTV5yuFVkY' }}
      FORCE_SYNC: ${{ github.event.inputs.force_sync || false }}
      GENERATE_ALL: ${{ github.event.inputs.generate_all_formats || true }}
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better change detection
          
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 📦 Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: 📚 Install dependencies
        run: |
          pnpm install --frozen-lockfile
          
      - name: 🔨 Build Figma MCP package
        run: |
          cd packages/figma-mcp
          pnpm build
          
      - name: 🔍 Check for design system changes
        id: check-changes
        run: |
          if [ "${{ env.FORCE_SYNC }}" = "true" ]; then
            echo "force_sync=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Check if there are design system changes
            if git diff --name-only HEAD~1 | grep -E "(design|components|KlikdBrandSystem|design-system)" > /dev/null; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: 🚀 Run design system sync
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
        run: |
          cd packages/figma-mcp
          
          # Run the auto-sync with appropriate flags
          if [ "${{ env.GENERATE_ALL }}" = "true" ]; then
            npx tsx src/scripts/auto-sync.ts \
              -f ${{ env.FIGMA_FILE_KEY }} \
              -o ./design-system-output \
              --generate-types \
              --generate-css \
              --generate-scss \
              --generate-storybook
          else
            npx tsx src/scripts/auto-sync.ts \
              -f ${{ env.FIGMA_FILE_KEY }} \
              -o ./design-system-output \
              --generate-types
          fi
          
      - name: 📊 Generate sync report
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cd packages/figma-mcp/design-system-output
          
          # Create a sync report
          echo "# 🎨 Design System Sync Report" > sync-report.md
          echo "" >> sync-report.md
          echo "**Generated:** $(date)" >> sync-report.md
          echo "**Trigger:** ${{ github.event_name }}" >> sync-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> sync-report.md
          echo "**Commit:** ${{ github.sha }}" >> sync-report.md
          echo "" >> sync-report.md
          
          # Count tokens by category
          if [ -f "design-tokens.json" ]; then
            echo "## 📊 Token Summary" >> sync-report.md
            echo "" >> sync-report.md
            echo "Total tokens generated: $(jq '.tokens | length' design-tokens.json)" >> sync-report.md
            echo "" >> sync-report.md
            
            # Count by category
            echo "### By Category:" >> sync-report.md
            for file in *-tokens.json; do
              if [ -f "$file" ]; then
                category=$(basename "$file" -tokens.json)
                count=$(jq '.tokens | length' "$file")
                echo "- **$category**: $count tokens" >> sync-report.md
              fi
            done
          fi
          
          echo "" >> sync-report.md
          echo "---" >> sync-report.md
          echo "*Auto-generated by Klikd Design System Auto-Sync*" >> sync-report.md
          
      - name: 📤 Upload design system artifacts
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: design-system-output-${{ github.run_number }}
          path: |
            packages/figma-mcp/design-system-output/
            packages/figma-mcp/sync-report.md
          retention-days: 30
          
      - name: 🔄 Commit updated design tokens
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          cd packages/figma-mcp
          
          # Configure git for the action
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all generated files
          git add design-system-output/ sync-report.md
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "🤖 Auto-sync design system tokens [skip ci]

            - Generated from Figma file: ${{ env.FIGMA_FILE_KEY }}
            - Trigger: ${{ github.event_name }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            
            Auto-generated by Klikd Design System Auto-Sync workflow"
          else
            echo "No changes to commit"
          fi
          
      - name: 🚀 Push design system updates
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Push the changes back to the repository
          git push origin HEAD:${{ github.ref }}
          
      - name: ✅ Sync completed
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "🎉 Design system sync completed successfully!"
          echo "📊 Check the artifacts for generated files"
          echo "📝 Review the sync report for details"
          
      - name: ⏭️ Skip sync (no changes)
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "⏭️ No design system changes detected, skipping sync"
          echo "💡 Use 'force_sync: true' to sync anyway"
